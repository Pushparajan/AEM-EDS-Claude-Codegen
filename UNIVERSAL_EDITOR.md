# AEM Universal Editor Support

> Enable in-context content editing with AEM Universal Editor

## Overview

All blocks generated by this tool include **built-in support for the AEM Universal Editor** by default. This allows content authors to edit content directly in-context using a visual interface.

### What is the AEM Universal Editor?

The **Universal Editor** is Adobe's modern, WYSIWYG content editing experience that allows authors to:
- ‚úèÔ∏è Edit content directly on the page (in-context editing)
- üëÅÔ∏è See changes in real-time
- üé® Use a visual properties panel
- üîÑ Work with any content source (AEM, external systems)

## How It Works

### 1. Instrumentation Attributes

The Universal Editor uses special `data-aue-*` attributes to make content editable:

```html
<div
  data-aue-resource="urn:aemconnection:/content/mysite/page"
  data-aue-type="component"
  data-aue-behavior="component">

  <h2 data-aue-prop="title" data-aue-type="text">
    Editable Title
  </h2>

  <div data-aue-prop="description" data-aue-type="richtext">
    Editable rich text content
  </div>
</div>
```

### 2. Key Attributes

| Attribute | Purpose | Example Values |
|-----------|---------|----------------|
| `data-aue-resource` | URN to the content resource | `urn:aemconnection:/content/...` |
| `data-aue-type` | Type of editable element | `text`, `richtext`, `reference`, `component`, `container` |
| `data-aue-prop` | Property name in AEM | `title`, `description`, `image` |
| `data-aue-label` | Custom label in properties panel | `Hero Title`, `Card Description` |
| `data-aue-filter` | Component filter | `cf` (content fragments) |
| `data-aue-behavior` | Enable move/delete operations | `component` |

### 3. Component Models

For the properties panel to work, you need a `component-models.json` file:

```json
{
  ":type": "sheet",
  "data": [
    {
      "id": "hero",
      "fields": [
        {
          "component": "text",
          "name": "title",
          "label": "Title",
          "valueType": "string"
        },
        {
          "component": "richtext",
          "name": "description",
          "label": "Description",
          "valueType": "string"
        },
        {
          "component": "reference",
          "name": "image",
          "label": "Background Image",
          "valueType": "string"
        }
      ]
    }
  ]
}
```

## Generated Code Features

### moveInstrumentation Helper

All generated blocks include this helper function:

```javascript
/**
 * Moves Universal Editor instrumentation attributes from source to target element.
 * This preserves in-context editing capabilities when restructuring the DOM.
 */
function moveInstrumentation(source, target) {
  if (source === target) return;

  const instrumentationAttrs = [
    'data-aue-resource',
    'data-aue-type',
    'data-aue-prop',
    'data-aue-label',
    'data-aue-filter',
    'data-aue-behavior',
  ];

  instrumentationAttrs.forEach((attr) => {
    const value = source.getAttribute(attr);
    if (value) {
      target.setAttribute(attr, value);
      source.removeAttribute(attr);
    }
  });
}
```

### Usage Example

When you restructure the DOM in your decorate function, use `moveInstrumentation`:

```javascript
export default function decorate(block) {
  const rows = [...block.children];

  rows.forEach((row) => {
    const cells = [...row.children];

    // Create new structure
    const card = document.createElement('div');
    card.className = 'card';

    // IMPORTANT: Preserve Universal Editor attributes
    moveInstrumentation(cells[0], card);

    // Add content
    card.innerHTML = cells[0].innerHTML;
    row.appendChild(card);
  });
}
```

## Disabling Universal Editor Support

If you don't need Universal Editor support, you can disable it:

### CLI

```bash
# When prompted during block generation
Enable Universal Editor support? (Y/n): n
```

### MCP Server (AI Assistant)

```
"Generate a hero block without Universal Editor support"
```

Or explicitly:

```javascript
{
  name: "hero",
  universalEditor: false
}
```

### API

```javascript
POST /api/generate-block
{
  "name": "hero",
  "options": {
    "universalEditor": false
  }
}
```

## Best Practices

### 1. Always Preserve Instrumentation

‚ùå **Don't** create new elements without moving attributes:
```javascript
const newEl = document.createElement('div');
newEl.innerHTML = cell.innerHTML; // Lost instrumentation!
```

‚úÖ **Do** use moveInstrumentation:
```javascript
const newEl = document.createElement('div');
moveInstrumentation(cell, newEl);
newEl.innerHTML = cell.innerHTML;
```

### 2. Keep Original Structure When Possible

The less DOM restructuring, the easier it is to maintain Universal Editor compatibility:

```javascript
// Simple approach - just add classes
export default function decorate(block) {
  block.classList.add('initialized');
  // Original structure preserved automatically
}
```

### 3. Use Semantic HTML

```javascript
// Good - semantic elements are easier to edit
const heading = document.createElement('h2');
const paragraph = document.createElement('p');

// Less ideal - generic divs need more metadata
const heading = document.createElement('div');
heading.className = 'heading';
```

### 4. Test with Universal Editor

After generating blocks:
1. Add component model definitions
2. Test in Universal Editor
3. Verify all fields are editable
4. Check move/delete operations work

## Component Model Field Types

Available field components for the properties panel:

| Component | Use For | Example |
|-----------|---------|---------|
| `text` | Short text | Titles, labels, names |
| `richtext` | Formatted text | Descriptions, body content |
| `reference` | Content references | Images, links, pages |
| `number` | Numeric values | Counts, dimensions |
| `boolean` | True/false | Feature toggles |
| `select` | Dropdown choices | Themes, variants |
| `multiselect` | Multiple choices | Tags, categories |
| `date` | Date values | Publication dates |

## Example: Cards Block with Universal Editor

### cards.js

```javascript
/**
 * Moves Universal Editor instrumentation attributes
 */
function moveInstrumentation(source, target) {
  if (source === target) return;

  const attrs = [
    'data-aue-resource',
    'data-aue-type',
    'data-aue-prop',
    'data-aue-label',
    'data-aue-filter',
    'data-aue-behavior',
  ];

  attrs.forEach((attr) => {
    const value = source.getAttribute(attr);
    if (value) {
      target.setAttribute(attr, value);
      source.removeAttribute(attr);
    }
  });
}

export default function decorate(block) {
  const ul = document.createElement('ul');

  [...block.children].forEach((row) => {
    const li = document.createElement('li');

    // Move instrumentation from row to list item
    moveInstrumentation(row, li);

    li.innerHTML = row.innerHTML;
    ul.appendChild(li);
  });

  block.textContent = '';
  block.appendChild(ul);
}
```

### component-models.json

```json
{
  ":type": "sheet",
  "data": [
    {
      "id": "cards",
      "fields": [
        {
          "component": "reference",
          "name": "image",
          "label": "Card Image",
          "valueType": "string"
        },
        {
          "component": "text",
          "name": "title",
          "label": "Card Title",
          "valueType": "string"
        },
        {
          "component": "richtext",
          "name": "description",
          "label": "Card Description",
          "valueType": "string"
        }
      ],
      "filter": {
        "name": "cards"
      }
    }
  ]
}
```

## Troubleshooting

### Content Not Editable

**Problem:** Click on content but nothing happens in Universal Editor

**Solutions:**
1. Check that `data-aue-*` attributes are present in the DOM
2. Verify component model exists in `component-models.json`
3. Ensure `data-aue-resource` has valid URN
4. Check browser console for errors

### Attributes Lost After Decoration

**Problem:** Block decorates but loses editing capabilities

**Solutions:**
1. Use `moveInstrumentation()` when creating new elements
2. Check that attributes weren't removed during DOM manipulation
3. Inspect final DOM to verify attributes are present

### Properties Panel Empty

**Problem:** Can select element but properties panel shows nothing

**Solutions:**
1. Verify `component-models.json` file exists
2. Check that model `id` matches block name
3. Ensure fields are properly defined
4. Validate JSON syntax

## Resources

### Official Documentation

- **[Creating Blocks for Universal Editor](https://www.aem.live/developer/universal-editor-blocks)** - Official guide for instrumenting blocks
- **[Universal Editor Introduction](https://experienceleague.adobe.com/en/docs/experience-manager-cloud-service/content/implementing/developing/universal-editor/introduction)** - Overview of Universal Editor
- **[Attributes and Types](https://experienceleague.adobe.com/en/docs/experience-manager-cloud-service/content/implementing/developing/universal-editor/attributes-types)** - Complete attribute reference
- **[Field Types](https://experienceleague.adobe.com/en/docs/experience-manager-cloud-service/content/implementing/developing/universal-editor/field-types)** - Component model field types
- **[Component Model Definitions](https://www.aem.live/developer/component-model-definitions)** - Content modeling guide

### Examples

- **[AEM Boilerplate](https://github.com/adobe/aem-boilerplate)** - Reference implementation with Universal Editor support
- **[Block Collection](https://www.aem.live/developer/block-collection)** - Pre-built blocks with examples

### Community Resources

- **[AEM Corner - Universal Editor with EDS](https://aemcorner.com/universal-editor-with-edge-delivery-service-for-aem/)** - Tutorial and guide
- **[Albin's Blog - Universal Visual Editor](https://www.albinsblog.com/2024/06/aem-universal-visual-editor-easily-auhtor-aem-content-anywhere-with-in-context-editing-part1.html)** - Deep dive series

## FAQs

### Q: Do I need Universal Editor support?

**A:** If you're using AEM authoring with Edge Delivery Services, yes. If you're using document-based authoring (Google Docs, SharePoint), it's optional.

### Q: Does this affect performance?

**A:** No. The `data-aue-*` attributes are only used by the Universal Editor and have no runtime impact.

### Q: Can I use this with other CMSs?

**A:** The Universal Editor is designed for AEM, but the instrumentation pattern can be adapted for other systems.

### Q: What if I modify the DOM extensively?

**A:** Use the `moveInstrumentation()` helper whenever you create new elements. This ensures attributes are preserved.

### Q: Do I need component models for every block?

**A:** Yes, if you want that block to be editable in the Universal Editor's properties panel.

---

**Generated blocks include Universal Editor support by default, making your content immediately editable in AEM's modern authoring experience.**
